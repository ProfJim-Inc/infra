# =============================================================================
# OpenSearch — Single-node, system pool
# =============================================================================

# Single node for now — scale up after Linode limit increase
replicas: 1
minimumMasterNodes: 1

nodeSelector:
  pool: system

# Disable security for internal-only cluster (enable once TLS certs are in place)
config:
  opensearch.yml: |
    cluster.name: creatium-logs
    network.host: 0.0.0.0
    plugins.security.disabled: true

extraEnvs:
  - name: DISABLE_INSTALL_DEMO_CONFIG
    value: "true"
  - name: DISABLE_SECURITY_PLUGIN
    value: "true"

# Java heap — keep under 50% of node RAM (system pool: g6-standard-2 = 4GB)
opensearchJavaOpts: "-Xmx1g -Xms1g"

resources:
  requests:
    cpu: 500m
    memory: 2Gi
  limits:
    cpu: 1000m
    memory: 2Gi

# Persistent storage via Linode block storage
persistence:
  enabled: true
  storageClass: "linode-block-storage"
  size: 20Gi

service:
  type: ClusterIP
  port: 9200

# vm.max_map_count must be >= 262144 for OpenSearch to start.
# This initContainer sets it on the host node before OpenSearch launches.
extraInitContainers:
  - name: sysctl
    image: busybox
    command: ["sysctl", "-w", "vm.max_map_count=262144"]
    securityContext:
      privileged: true
      runAsUser: 0

# OpenSearch is slow to start (JVM init + block storage mount)
# Give it up to 10 minutes before failing
startupProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 60   # 30s + (60 * 10s) = 10 min total
  successThreshold: 1

readinessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

livenessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 20
  timeoutSeconds: 5
  failureThreshold: 5
